<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>座席ビューア</title>
  <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Mochiy Pop One', sans-serif;
      background: linear-gradient(to bottom right, #ffecd2, #fcb69f);
      margin: 0;
      padding: 0;
    }
    .hidden { display: none; }
    #homeScreen, #viewerScreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      text-align: center;
    }
    h1 {
      color: #ff6f61;
      font-size: 2em;
      margin-bottom: 10px;
    }
    p {
      font-size: 1.1em;
      color: #444;
    }
    button {
      background: #ff6f61;
      color: white;
      border: none;
      border-radius: 25px;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
      margin: 10px;
      transition: all 0.2s ease;
    }
    button:hover {
      background: #ff3b2e;
      transform: scale(1.05);
    }
    input {
      padding: 10px;
      border: 2px solid #ff6f61;
      border-radius: 10px;
      font-size: 16px;
      margin-bottom: 10px;
    }
    canvas { border: 1px solid #ccc; margin-top: 20px; max-width: 100%; }
    #output {
      margin-top: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #ccc;
      text-align: left;
      max-width: 600px;
      width: 90%;
    }
    #minimap {
      position: absolute;
      top: 20px;
      right: 20px;
      border: 1px solid #999;
      width: 300px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="homeScreen">
    <h1>ようこそ！</h1>
    <p>グループの座席配置をチェックしよう</p>
    <button onclick="goToViewer()">座席配置を見る</button>
  </div>

  <div id="viewerScreen" class="hidden">
    <h1>座席ビューア</h1>
    <p>学籍番号を入力してください</p>
    <input type="text" id="studentId" placeholder="学籍番号" />
    <button onclick="highlightGroup()">表示</button>
    <button onclick="goHome()">ホームに戻る</button>

    <canvas id="seatCanvas"></canvas>
    <div id="output"></div>
    <canvas id="minimap" title="クリックで拡大/全体を切り替え"></canvas>
  </div>

  <script>
    const homeScreen = document.getElementById("homeScreen");
    const viewerScreen = document.getElementById("viewerScreen");

    function goToViewer() {
      homeScreen.classList.add("hidden");
      viewerScreen.classList.remove("hidden");
      drawSeats(currentSeat, currentGroup);
    }

    function goHome() {
      viewerScreen.classList.add("hidden");
      homeScreen.classList.remove("hidden");
    }

    const canvas = document.getElementById("seatCanvas");
    const ctx = canvas.getContext("2d");
    const minimap = document.getElementById("minimap");
    const mctx = minimap.getContext("2d");
    const output = document.getElementById("output");
    const image = new Image();
    image.src = "seatmap.png.jpg";

    const zoomSize = 200;
    const zoomScale = 3;

    const seatData = {
      "A": [{ start: 1, count: 10, x: 150, y: 800, dy: 45.5 }],
      "B": [{ start: 1, count: 10, x: 300, y: 800, dy: 45.5 }]
    };

    const studentToSeat = {
      "123456": "A01",
      "123457": "A02",
      "123458": "B03"
    };

    const groups = [["123456", "123457", "123458"]];

    let highlightBox = null;
    let zoomedIn = true;
    let fullImageLoaded = false;
    let currentSeat = null;
    let currentGroup = [];

    image.onload = () => {
      fullImageLoaded = true;
      minimap.width = 300;
      minimap.height = image.height / image.width * minimap.width;
      drawSeats();
    };

    minimap.addEventListener("click", () => {
      zoomedIn = !zoomedIn;
      drawSeats(currentSeat, currentGroup);
    });

    function drawSeats(mySeat = null, groupSeats = []) {
      if (!fullImageLoaded) return;

      let highlight = null;
      for (const col in seatData) {
        for (const segment of seatData[col]) {
          for (let i = 0; i < segment.count; i++) {
            const seatNum = segment.start + i;
            const label = `${col}${String(seatNum).padStart(2, '0')}`;
            if (label === mySeat) {
              highlight = { x: segment.x, y: segment.y - segment.dy * i };
            }
          }
        }
      }

      highlightBox = highlight;
      const scale = (zoomedIn && highlightBox) ? zoomScale : 1;

      if (zoomedIn && highlightBox) {
        const sx = Math.max(0, highlightBox.x - zoomSize / 2);
        const sy = Math.max(0, highlightBox.y - zoomSize / 2);
        canvas.width = zoomSize * zoomScale;
        canvas.height = zoomSize * zoomScale;
        ctx.drawImage(image, sx, sy, zoomSize, zoomSize, 0, 0, canvas.width, canvas.height);
      } else {
        canvas.width = image.width;
        canvas.height = image.height;
        ctx.drawImage(image, 0, 0);
      }

      for (const col in seatData) {
        for (const segment of seatData[col]) {
          for (let i = 0; i < segment.count; i++) {
            const seatNum = segment.start + i;
            const label = `${col}${String(seatNum).padStart(2, '0')}`;
            let x = segment.x;
            let y = segment.y - segment.dy * i;

            if (zoomedIn && highlightBox) {
              x = (x - highlightBox.x + zoomSize / 2) * zoomScale;
              y = (y - highlightBox.y + zoomSize / 2) * zoomScale;
            }

            ctx.beginPath();
            ctx.arc(x, y, 6 * scale, 0, Math.PI * 2);
            if (label === mySeat) {
              ctx.fillStyle = "yellow";
              ctx.fill();
              ctx.strokeStyle = "black";
              ctx.lineWidth = 2 * scale;
              ctx.stroke();
            } else if (groupSeats.includes(label)) {
              ctx.fillStyle = "lightblue";
              ctx.fill();
            } else {
              ctx.fillStyle = "rgba(255, 0, 0, 0.3)";
              ctx.fill();
            }

            ctx.fillStyle = "black";
            ctx.font = `${10 * scale}px sans-serif`;
            ctx.fillText(label, x + 10 * scale, y + 3 * scale);
          }
        }
      }

      const s = minimap.width / image.width;
      mctx.clearRect(0, 0, minimap.width, minimap.height);
      mctx.drawImage(image, 0, 0, minimap.width, minimap.height);
      if (highlightBox) {
        mctx.strokeStyle = "gold";
        mctx.lineWidth = 1;
        mctx.strokeRect(
          (highlightBox.x - zoomSize / 2) * s,
          (highlightBox.y - zoomSize / 2) * s,
          zoomSize * s,
          zoomSize * s
        );
      }
    }

    function highlightGroup() {
      const inputId = document.getElementById("studentId").value.trim();
      const mySeat = studentToSeat[inputId];
      if (!mySeat) {
        currentSeat = null;
        currentGroup = [];
        output.innerHTML = "<strong>エラー:</strong> 学籍番号が登録されていません。";
        drawSeats();
        return;
      }

      zoomedIn = true;
      const myGroup = groups.find(g => g.includes(inputId)) || [];
      const groupInfo = myGroup.map(id => ({ id, seat: studentToSeat[id] || "-" }));

      currentSeat = mySeat;
      currentGroup = groupInfo.map(g => g.seat).filter(s => s !== mySeat);

      drawSeats(currentSeat, currentGroup);

      output.innerHTML = `
        <strong>あなたの席:</strong> ${mySeat}<br>
        <strong>グループ:</strong><br>
        <ul>
          ${groupInfo.map(g => `<li>${g.id} → ${g.seat}${g.id === inputId ? "（あなた）" : ""}</li>`).join("")}
        </ul>
      `;
    }
  </script>
</body>
</html>
